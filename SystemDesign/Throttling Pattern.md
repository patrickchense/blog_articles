## 节流器模式(Throttling Pattern)	

控制一个实例，一个用户或者一个服务消耗的资源。可以帮助系统达到SLA，即使某些情况下大流量消耗。

### Context and Problem

系统负载一般谁时间变化，取决于用户数量和服务的类型。比如，工作时间系统比较繁忙，或者月底会有很多计算任务。也可能是突然，超出预计的负载。如果系统的负载超过了可承载范围，可能会导致性能降低甚至挂掉。如果系统有SLA要求，这种情况是不能接受的。

在云端情况下，面对变化的负载有很多策略可用。其中一个策略自动扩展足够资源已达到要求。这个策略可用持续满足用户优化资源的需求。但是自动扩展需要触发资源的申请和供应，这些步骤不是立即的。如果负载突然增加，会导致一段时间的资源短缺。

### Solution

一个折中的方案是自动扩展有个上限，一旦到了这个上限就采取限流。系统应该提供监控，一旦资源上限到了，就对用户限流。这样系统就可以平稳运行，达到要求的SLA。

系统可以实现的节流策略：

* 拒绝在一段时间内访问次数过多的用户。这要求系统设计这样的用户监控。
* 对非重要功能限流或者关掉，保证重要服务可用。比如视频网站，可用降低解析度。
* 使用负载均衡来平滑处理用度。在多用户场景下，会降低每个用户的体验。如果系统需要对不同的用户采用不同的SLA，需要采用优先级队列模式。
* 延迟对低优先级的服务或者用户的支持。这些操作可以延迟和限制，比如通知用户“系统繁忙，请稍后尝试“。

下面图就是对每个功能的监控，消耗的系统资源，三个服务，B在中间（T1-T2）被暂停了，然后系统消耗降低后，T2之后恢复了。

自动扩展和节流可以一起合作来达到SLA。如果系统消耗持续保持在高位，节流可以临时帮助系统争取自动扩展的时间。这个节点，系统保证正常运行。

下面的图，展现了自动扩展和节流的监控：



### Issues and Considerations

在实现节流的时候，考虑下面这些点：

* 系统节流，是一个设计问题，应该在系统实现早期加入其中，一旦成型，很难加入。
* 节流需要快速实现。这就要求系统能够实时响应负载变化，迅速反应。而且系统也要能在负载下降后快速回归正常。这些的前提是系统对于性能数据的持续监控和捕捉。
* 系统如果要对用户请求节流，就需要返回客户端能够识别的错误码，这样客户端能够处理相关逻辑，比如等待一段时间在尝试。
* 节流作为自动扩展触发时的临时手段。一些情况下，节流比自动扩展更合适，因为负载增加可能是短期的爆发式的，而不会长期增加，自动扩展会增加成本。
* 如果节流时，因为系统负载快速增加，还是crush了，那么需要考虑更极端的措施，比如更激进的自动扩展策略。

### When to use this pattern

适用：

* 需要保证SLA
* 防止单个用户占用太多的系统资源
* 处理突发事件
* 通过限制系统所需最大资源来保证正常运行

### 例子

比如，最近在搜索机票（国外回国），不同在携程等代理买了，只能在官网，国内航空公司的官网是非常烂的，我只在5分钟内搜索了大概20次，就被限流了，需要输入验证码才能继续搜索。



### 相关模式

Service Metering 

AutoScaling

Queue-Based Load Leveling Pattern

Priority Queue Pattern


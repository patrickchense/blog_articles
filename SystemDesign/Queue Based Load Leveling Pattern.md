## 基于队列的负载均衡模式(Queue-Based Load Leveling pattern)

使用队列充当任务和它所调用的服务之间的缓冲区，以平滑可能导致服务失败或任务超时的间歇性重负载。 这可以帮助最大程度地减少需求高峰对任务和服务的可用性和响应能力的影响。

### 环境和问题

云中的许多解决方案都涉及运行任务以调用服务。 在这种环境下，如果服务承受间歇性重负载，则可能导致性能或可靠性问题。

服务可以是与使用它的任务相同的解决方案的一部分，也可以是第三方服务，提供对频繁使用的资源（例如缓存或存储服务）的访问。 如果同时运行的多个任务使用同一服务，则可能很难随时预测对该服务的请求量。

服务可能会遇到需求高峰，从而导致其过载，并且无法及时响应请求。 如果服务无法处理这些请求引起的争用，则将大量的并发请求泛洪到服务中也会导致服务失败。

### 解决

重构解决方案，并在任务和服务之间引入队列。 任务和服务异步运行。 该任务将包含服务所需数据的消息发布到队列中。 队列充当缓冲区，存储消息，直到服务检索到消息为止。 该服务从队列中检索消息并进行处理。 来自多个任务的请求（可以以高度可变的速率生成）可以通过同一消息队列传递给服务。 该图显示了使用队列来均衡服务的负载。

队列将任务与服务分离，并且服务可以按照自己的速度处理消息，而不管并发任务的请求量如何。 此外，如果服务在将消息发布到队列时不可用，则不会延迟任务。

这种模式具有以下优点：

* 它可以帮助最大化可用性，因为服务中的延迟不会对应用程序产生直接和直接的影响，即使服务不可用或当前未在处理消息，该应用程序也可以继续将消息发布到队列中。
* 它可以帮助最大化可伸缩性，因为队列数量和服务数量都可以变化以满足需求。
* 它可以帮助控制成本，因为部署的服务实例的数量仅必须足以满足平均负载，而不是峰值负载。

> 当需求达到阈值时，某些服务会进行限制，超过该阈值系统可能会发生故障。 节流会减少可用的功能。 您可以使用这些服务实施负载均衡，以确保未达到此阈值。

### 问题和注意点

在决定如何实现此模式时，请考虑以下几点：

* 有必要实现应用程序逻辑来控制服务处理消息的速率，以避免压倒目标资源。 避免将需求高峰传递到系统的下一阶段。 测试负载下的系统，以确保它提供了所需的级别，并调整队列数和处理消息的服务实例数以实现此目的。
* 消息队列是一种单向通信机制。 如果任务期望服务提供答复，则可能有必要实现一种服务可以用来发送响应的机制。
* 如果将自动缩放应用于正在侦听队列中请求的服务，请小心。 这可能导致对这些服务共享的任何资源的争用增加，并降低使用队列均衡负载的有效性。

### 什么时候用

此模式对使用将承受过载的服务的任何应用程序很有用。

如果应用程序期望服务以最小的延迟响应，则此模式无用。

